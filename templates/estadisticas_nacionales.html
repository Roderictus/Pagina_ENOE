<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Panel ENOE - Nacionales</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body { font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, #f8fafc, #eef2ff); color: #0f172a; }
    .navbar-brand { font-weight: 700; letter-spacing: -0.01em; }
    .card-soft { border-radius: 1rem; border: 1px solid #e5e7eb; box-shadow: 0 12px 30px rgba(15,23,42,0.08); background: #fff; }
    .chart-area { width: 100%; height: 460px; }
    .color-dot { width: 12px; height: 12px; display: inline-block; border-radius: 50%; border: 1px solid rgba(0,0,0,0.2); }
    .table tr td { vertical-align: middle; }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Panel ENOE</a>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-light" href="{{ url_for('estatales') }}">Estatales</a>
        <a class="btn btn-light" href="{{ url_for('nacionales') }}">Nacionales</a>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-3 gap-2">
      <div>
        <h1 class="h4 mb-1">Estadísticas nacionales ENOE</h1>
        <p class="text-muted mb-0 small">Activa varias variables por pestaña para comparar; el eje Y se recalcula en cada cambio.</p>
      </div>
    </div>

    <ul class="nav nav-tabs mb-3" id="grupoTabs" role="tablist">
      {% for grupo in grupos %}
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if loop.first %}active{% endif %}" id="tab-btn-{{ grupo.id }}" data-bs-toggle="tab" data-bs-target="#tab-{{ grupo.id }}" type="button" role="tab" aria-controls="tab-{{ grupo.id }}" aria-selected="{{ 'true' if loop.first else 'false' }}" data-group="{{ grupo.id }}">{{ grupo.title }}</button>
      </li>
      {% endfor %}
    </ul>

    <div class="tab-content" id="grupoTabsContent">
      {% for grupo in grupos %}
      <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="tab-{{ grupo.id }}" role="tabpanel" aria-labelledby="tab-btn-{{ grupo.id }}">
        <div class="row g-3 align-items-stretch">
          <div class="col-lg-8">
            <div class="card-soft p-3 h-100">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-semibold text-secondary small">{{ grupo.description }}</div>
                <span class="badge bg-light text-dark border">{{ 'Selección múltiple' if grupo.selection == 'multi' else 'Selección única' }}</span>
              </div>
              <div id="chart-{{ grupo.id }}" class="chart-area"></div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="card-soft p-3 h-100">
              <h2 class="h6 mb-3">Variables</h2>
              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <tbody>
                    {% for var in grupo.variables %}
                    <tr>
                      <td class="text-nowrap"><span class="color-dot me-2" style="background: {{ var.color }};"></span>{{ var.label }}</td>
                      <td class="text-end">
                        {% if grupo.selection == 'single' %}
                        <input class="form-check-input variable-toggle" type="radio" name="group-{{ grupo.id }}" data-group="{{ grupo.id }}" value="{{ var.id }}" {% if var.checked %}checked{% endif %}>
                        {% else %}
                        <input class="form-check-input variable-toggle" type="checkbox" data-group="{{ grupo.id }}" value="{{ var.id }}" {% if var.checked %}checked{% endif %}>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <p class="text-muted small mb-0 mt-2">En “Otras variables” la selección es única para facilitar la lectura de ejes.</p>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const labels = {{ labels|tojson }};
    const grupos = {{ grupos|tojson }};
    const selectionState = {};
    const renderedCharts = new Set();

    grupos.forEach((grupo) => {
      if (grupo.selection === "single") {
        const defaultVar = grupo.variables.find((v) => v.checked) || grupo.variables[0];
        selectionState[grupo.id] = defaultVar ? defaultVar.id : null;
      } else {
        selectionState[grupo.id] = new Set(
          grupo.variables.filter((v) => v.checked).map((v) => v.id)
        );
      }
    });

    function getGrupo(id) {
      return grupos.find((g) => g.id === id);
    }

    function getActiveVariables(grupo) {
      if (!grupo) return [];
      if (grupo.selection === "single") {
        const activeId = selectionState[grupo.id];
        return grupo.variables.filter((v) => v.id === activeId);
      }
      const selected = selectionState[grupo.id];
      return grupo.variables.filter((v) => selected.has(v.id));
    }

    function computeRange(activeVars) {
      const values = activeVars.flatMap((v) => v.data.filter((n) => Number.isFinite(n)));
      if (!values.length) return null;
      const min = Math.min(...values);
      const max = Math.max(...values);
      const span = max - min || Math.abs(max) || 1;
      const padding = span * 0.08;
      return [min - padding, max + padding];
    }

    function renderChart(grupoId) {
      const grupo = getGrupo(grupoId);
      if (!grupo) return;

      const activeVars = getActiveVariables(grupo);
      const chartEl = document.getElementById(`chart-${grupoId}`);
      if (!chartEl) return;

      const traces = activeVars.map((vari) => ({
        x: labels,
        y: vari.data,
        type: "scatter",
        mode: "lines+markers",
        name: vari.label,
        line: { width: 3, color: vari.color },
        marker: { size: 6, color: vari.color },
        hovertemplate: `<b>%{x}</b><br>${vari.label}: %{y:.${vari.decimals}f}<extra></extra>`
      }));

      const yRange = computeRange(activeVars);

      const layout = {
        margin: { l: 60, r: 20, t: 24, b: 60 },
        xaxis: { type: "category", tickangle: -65, showgrid: false, title: "Periodo (año-trimestre)" },
        yaxis: { rangemode: "tozero", range: yRange || undefined },
        showlegend: true,
        hovermode: "x unified",
        plot_bgcolor: "#fff",
        paper_bgcolor: "#fff",
        font: { family: "Inter, 'Segoe UI', system-ui, sans-serif", size: 12, color: "#0f172a" },
      };

      if (!traces.length) {
        layout.annotations = [
          { text: "Selecciona al menos una variable", showarrow: false, xref: "paper", yref: "paper", x: 0.5, y: 0.5, font: { color: "#9ca3af" } }
        ];
      } else {
        layout.annotations = [];
      }

      Plotly.react(chartEl, traces, layout, { responsive: true, displayModeBar: false });
      renderedCharts.add(grupoId);
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (grupos.length) {
        renderChart(grupos[0].id);
      }

      document.querySelectorAll(".variable-toggle").forEach((input) => {
        input.addEventListener("change", (evt) => {
          const groupId = evt.target.dataset.group;
          const grupo = getGrupo(groupId);
          if (!grupo) return;

          if (grupo.selection === "single") {
            selectionState[groupId] = evt.target.value;
          } else {
            const selectedSet = selectionState[groupId];
            if (evt.target.checked) {
              selectedSet.add(evt.target.value);
            } else {
              selectedSet.delete(evt.target.value);
            }
          }
          renderChart(groupId);
        });
      });

      document.querySelectorAll('button[data-bs-toggle="tab"]').forEach((btn) => {
        btn.addEventListener('shown.bs.tab', (evt) => {
          const groupId = evt.target.dataset.group;
          renderChart(groupId);
          const chartEl = document.getElementById(`chart-${groupId}`);
          if (chartEl) {
            Plotly.Plots.resize(chartEl);
          }
        });
      });
    });
  </script>
</body>
</html>
