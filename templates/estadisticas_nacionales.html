<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Panel ENOE - Nacional</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f5f7; }
    .card-soft { border-radius: 1rem; border: 1px solid #e5e7eb; box-shadow: 0 10px 25px rgba(15,23,42,0.06); background: #fff; }
    #grafico-tasa { width: 100%; height: 420px; }
    .color-dot { width: 12px; height: 12px; display: inline-block; border-radius: 50%; border: 1px solid rgba(0,0,0,0.15); }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Panel ENOE</a>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-light" href="{{ url_for('estatales') }}">Estatales</a>
        <a class="btn btn-light" href="{{ url_for('nacionales') }}">Nacionales</a>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <h2 class="h4 mb-1">Visión nacional</h2>
    <p class="text-muted">Activa las series porcentuales para comparar la estructura de ocupación nacional.</p>

    <div class="card-soft p-3">
      <div class="row g-3">
        <div class="col-lg-8">
          <h3 class="h6 mb-2">Series porcentuales nacionales</h3>
          <div id="grafico-tasa"></div>
        </div>
        <div class="col-lg-4">
          <div class="border rounded-3 p-3 h-100">
            <h4 class="h6 mb-2">Selecciona variables</h4>
            <div class="list-group list-group-flush small" id="percent-checklist">
              {% for item in percent_variables %}
              <label class="list-group-item d-flex align-items-center gap-2">
                <input class="form-check-input me-2 percent-toggle" type="checkbox" value="{{ item.id }}" {% if item.checked %}checked{% endif %}>
                <span class="color-dot" style="background-color: {{ item.color }};"></span>
                <span>{{ item.label }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const labels = {{ labels|tojson }};
    const percentVariables = {{ percent_variables|tojson }};
    const percentState = Object.fromEntries(percentVariables.map(v => [v.id, { ...v }]));

    function dibujarGraficoNacional() {
      const activeTraces = [];
      Object.values(percentState).forEach((serie) => {
        if (!serie.checked) return;
        activeTraces.push({
          x: labels,
          y: serie.data,
          type: "scatter",
          mode: "lines+markers",
          name: serie.label,
          line: { width: 3, color: serie.color || undefined },
          marker: { size: 6, color: serie.color || undefined },
          hovertemplate: "<b>Año %{x}</b><br>" + `${serie.label}: %{y:.2f}%<extra></extra>`
        });
      });

      Plotly.newPlot("grafico-tasa", activeTraces, {
        margin: {l: 60, r: 20, t: 30, b: 60},
        xaxis: { title: "Periodo (trimestres)", type: "category", tickangle: -65, showgrid: false },
        yaxis: { title: "Porcentaje (%)", rangemode: "tozero" },
        showlegend: true,
        hovermode: "x unified",
        plot_bgcolor: "#fff",
        paper_bgcolor: "#fff",
        font: { family: "system-ui", size: 13, color: "#111827" }
      }, { responsive: true, displayModeBar: false });
    }

    document.addEventListener("DOMContentLoaded", () => {
      dibujarGraficoNacional();
      document.querySelectorAll(".percent-toggle").forEach((input) => {
        input.addEventListener("change", (evt) => {
          const id = evt.target.value;
          if (percentState[id]) {
            percentState[id].checked = evt.target.checked;
            dibujarGraficoNacional();
          }
        });
      });
    });
  </script>
</body>
</html>
