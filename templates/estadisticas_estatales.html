<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Panel ENOE - Estatales</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f5f7; }
    #map { width: 100%; height: 520px; border: 1px solid #e5e7eb; border-radius: 1rem; }
    .card-soft { border-radius: 1rem; border: 1px solid #e5e7eb; box-shadow: 0 10px 25px rgba(15,23,42,0.06); background: #fff; }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Panel ENOE</a>
      <div class="d-flex gap-2">
        <a class="btn btn-light" href="{{ url_for('estatales') }}">Estatales</a>
        <a class="btn btn-outline-light" href="{{ url_for('nacionales') }}">Nacionales</a>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="card-soft p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <h2 class="h5 mb-1">Mapa estatal</h2>
          <p class="text-muted small mb-0">Datos del trimestre T {{ ultimo_quarter }} {{ ultimo_year }}.</p>
        </div>
      </div>
      <div id="map"></div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    let map;
    let geojsonLayer;

    function colorForTasa(tasa) {
      if (typeof tasa !== 'number') return '#d1d5db';
      const t = Math.max(0, Math.min(1, tasa / 10));
      const base = Math.round(220 - 80 * t);
      return `rgb(${base}, ${base}, ${base})`;
    }

    async function initMap() {
      map = L.map('map').setView([23.0, -102.0], 4.5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 7,
        minZoom: 4,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      const resp = await fetch('/static/data/mexico_estados.json');
      const gj = await resp.json();

      geojsonLayer = L.geoJSON(gj, {
        style: (feature) => ({
          color: '#6b7280',
          weight: 1,
          fillColor: colorForTasa(feature.properties.tasa_desocupacion),
          fillOpacity: 0.9
        }),
        onEachFeature: (feature, layer) => {
          const nombre = feature.properties.ent_nombre || feature.properties.shapeName;
          const tasa = feature.properties.tasa_desocupacion;
          let tip = nombre;
          if (typeof tasa === 'number') tip += `\nTasa desocupación: ${tasa.toFixed(2)}%`;
          layer.bindTooltip(tip);
        }
      }).addTo(map);
    }

    document.addEventListener('DOMContentLoaded', () => {
      initMap();
    });
  </script>
</body>
</html>
