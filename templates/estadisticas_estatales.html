<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Panel ENOE - Estatales</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f5f7; }
    #map { width: 100%; height: 520px; border: 1px solid #f2e8df; border-radius: 1rem; }
    .card-soft { border-radius: 1rem; border: 1px solid #e5e7eb; box-shadow: 0 10px 25px rgba(15,23,42,0.06); background: #fff; }
    .legend {
      position: absolute;
      bottom: 16px;
      right: 16px;
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 8px 10px;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
      font-size: 12px;
      line-height: 1.4;
    }
    .legend .swatch {
      display: inline-block;
      width: 14px;
      height: 10px;
      border-radius: 2px;
      margin-right: 6px;
      border: 1px solid rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Panel ENOE</a>
      <div class="d-flex gap-2">
        <a class="btn btn-light" href="{{ url_for('estatales') }}">Estatales</a>
        <a class="btn btn-outline-light" href="{{ url_for('nacionales') }}">Nacionales</a>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="card-soft p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <h2 class="h5 mb-1">Mapa estatal</h2>
          <p class="text-muted small mb-0">Datos del trimestre T {{ ultimo_quarter }} {{ ultimo_year }}.</p>
        </div>
      </div>
      <div id="map"></div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    let map;
    let geojsonLayer;

    const BREAKS = {{ legend_breaks|tojson }};
    const LEGEND_TITLE = "{{ legend_title }}";

    function computeRange(values, tipo) {
      const nums = values.filter((n) => Number.isFinite(n));
      if (!nums.length) return null;
      const min = Math.min(...nums);
      const max = Math.max(...nums);
      const avg = nums.reduce((a, b) => a + b, 0) / nums.length;
      if (tipo === 'porcentual') {
        return { min: Math.min(0, min - 5), max: max + 5 };
      }
      const delta = avg * 0.1;
      return { min: min - delta, max: max + delta };
    }

    function colorForDato(dato) {
      if (typeof dato !== 'number') return '#f4f4f5';
      const b = BREAKS.find(br => dato <= br.max) || BREAKS[BREAKS.length - 1];
      return b.color;
    }

    async function initMap() {
      map = L.map('map', { zoomControl: false }).setView([23.0, -102.0], 4.5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 7,
        minZoom: 4,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      // Usamos el endpoint enriquecido para incluir Datos imputados
      const resp = await fetch('/api/estados/geojson');
      const gj = await resp.json();

      geojsonLayer = L.geoJSON(gj, {
        style: (feature) => ({
          color: '#ffffff',
          weight: 0.8,
          fillColor: colorForDato(feature.properties.ingreso_prom_mensual),
          fillOpacity: 0.9
        }),
        onEachFeature: (feature, layer) => {
          const nombre = feature.properties.ent_nombre || feature.properties.shapeName;
          const dato = feature.properties.ingreso_prom_mensual;
          let tip = nombre;
          if (typeof dato === 'number') tip += `\nIngreso Promedio Mensual: ${dato.toFixed(2)}`;
          layer.bindTooltip(tip);
        }
      }).addTo(map);

      // Leyenda inferior derecha
      const legend = L.control({ position: 'bottomright' });
      legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'legend');
        const title = document.createElement('div');
        title.style.fontWeight = '600';
        title.style.marginBottom = '6px';
        title.textContent = "{{ legend_title }}";
        div.appendChild(title);
        BREAKS.forEach((br) => {
          const row = document.createElement('div');
          const swatch = document.createElement('span');
          swatch.className = 'swatch';
          swatch.style.backgroundColor = br.color;
          row.appendChild(swatch);
          row.appendChild(document.createTextNode(br.label));
          div.appendChild(row);
        });
        return div;
      };
      legend.addTo(map);
    }

    document.addEventListener('DOMContentLoaded', () => {
      initMap();
    });
  </script>
</body>
</html>
